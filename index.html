<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Check My Steno</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- Firebase JS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore-compat.js"></script>
  <style>
    /* CSS Variables for Theming */
    :root {
        /* Default Theme Colors (Modern Flat-Glass Aesthetic) */
        --primary-bg: #f3f4f6; /* Light grey */
        --login-bg: white;
        
        /* Sidebar */
        --sidebar-bg: #1e293b; /* Navy Blue */
        --sidebar-text: white;
        --sidebar-hover-bg: rgba(255, 255, 255, 0.15); /* Slightly more opaque hover */
        --sidebar-shadow-color: rgba(0,0,0,0.2); /* Enhanced shadow */
        --sidebar-collapsed-width: 80px; /* Width when collapsed */

        /* Header */
        --header-gradient-start: #7c3aed; /* Purple */
        --header-gradient-end: #4f46e5; /* Indigo */
        --header-text: white;
        --header-shadow-color: rgba(0, 0, 0, 0.3); /* Deeper shadow */
        --profile-icon-color: white;

        /* Active Link / Button Accents */
        --active-link-gradient-start: #6366f1; /* Indigo */
        --active-link-gradient-end: #ec4899; /* Pink */
        --active-link-shadow-color: rgba(99, 102, 241, 0.6); /* Stronger shadow */
        --active-link-border: white; /* White border for active link */

        /* General Text & Elements */
        --text-color: #333;
        --secondary-text-color: #6b7280;
        --input-border: #cbd5e1;
        --input-focus-shadow: rgba(0, 0, 0, 0.25); /* Stronger focus shadow */
        --button-gradient-start: #6366f1; /* Indigo */
        --button-gradient-end: #ec4899; /* Pink */
        --button-text: white;
        --logout-color: #ef4444; /* Red tone for logout */
        --error-color: #ef4444; /* Error red */
        --card-bg: rgba(255, 255, 255, 0.9); /* Semi-transparent white for flat-glass */
        --card-shadow: rgba(0, 0, 0, 0.15); /* Soft, elevated shadow */
        --card-border: rgba(226, 232, 240, 0.7); /* Softer border */

        /* Toggle Button */
        --toggle-btn-gradient-start: #6a82fb;
        --toggle-btn-gradient-end: #fc5c7d;
        --toggle-btn-text: white;
        --toggle-btn-shadow: rgba(0, 0, 0, 0.25);

        /* Loading Spinner */
        --spinner-color: #6366f1; /* Indigo */
    }

    /* Dark Theme */
    html[data-theme='Dark'] {
        --primary-bg: #1a202c;
        --login-bg: #2d3748;
        --sidebar-bg: #2d3748;
        --sidebar-text: #f7fafc;
        --sidebar-hover-bg: rgba(255, 255, 255, 0.08);
        --sidebar-shadow-color: rgba(0,0,0,0.6);
        --header-gradient-start: #4a5568;
        --header-gradient-end: #2d3748;
        --header-text: #f7fafc;
        --header-shadow-color: rgba(0, 0, 0, 0.6);
        --profile-icon-color': '#f7fafc;
        --active-link-gradient-start: #ecc94b;
        --active-link-gradient-end: #ed8936;
        --active-link-shadow-color: rgba(236, 178, 101, 0.4);
        --active-link-border: #ecc94b;
        --text-color: #f7fafc;
        --secondary-text-color: #cbd5e1;
        --input-border: #4a5568;
        --input-focus-shadow: rgba(0, 0, 0, 0.5);
        --button-gradient-start: #ecc94b;
        --button-gradient-end: #ed8936;
        --button-text: #2d3748;
        --logout-color: #feb2b2;
        --error-color: #fc8181;
        --card-bg: rgba(45, 55, 72, 0.9);
        --card-shadow': 'rgba(0, 0, 0, 0.5);
        --card-border': 'rgba(74, 85, 104, 0.7);
        --toggle-btn-gradient-start: #ecc94b;
        --toggle-btn-gradient-end: #ed8936;
        --toggle-btn-text: #2d3748;
        --toggle-btn-shadow: rgba(0, 0, 0, 0.5);
        --spinner-color: #ecc94b;
    }

    /* Ocean Blue Theme */
    html[data-theme='Ocean Blue'] {
        --primary-bg: #e0f2f7;
        --login-bg: #ffffff;
        --sidebar-bg: #0a1d37;
        --sidebar-text: #e0f2f7;
        --sidebar-hover-bg: rgba(173, 216, 230, 0.15);
        --sidebar-shadow-color: rgba(0,0,0,0.25);
        --header-gradient-start: #4299e1;
        --header-gradient-end: #3182ce;
        --header-text: white;
        --header-shadow-color: rgba(0, 0, 0, 0.25);
        --profile-icon-color': 'white;
        --active-link-gradient-start: #667eea;
        --active-link-gradient-end: #764ba2;
        --active-link-shadow-color: rgba(102, 126, 234, 0.5);
        --active-link-border: white;
        --text-color: #2a4365;
        --secondary-text-color: #4a5568;
        --input-border: #a0aec0;
        --input-focus-shadow: rgba(0, 0, 0, 0.2);
        --button-gradient-start: #4299e1;
        --button-gradient-end: #3182ce;
        --button-text: white;
        --logout-color: #f56565;
        --error-color: #e53e3e;
        --card-bg: rgba(255, 255, 255, 0.9);
        --card-shadow': 'rgba(0, 0, 0, 0.15);
        --card-border': 'rgba(237, 242, 247, 0.7);
        --toggle-btn-gradient-start: #4299e1;
        --toggle-btn-gradient-end: #3182ce;
        --toggle-btn-text: white;
        --toggle-btn-shadow: rgba(0, 0, 0, 0.25);
        --spinner-color: #4299e1;
    }

    /* Forest Green Theme */
    html[data-theme='Forest Green'] {
        --primary-bg: #f0fdf4;
        --login-bg: #ffffff;
        --sidebar-bg: #143105;
        --sidebar-text: #ecfdf5;
        --sidebar-hover-bg: rgba(144, 238, 144, 0.15);
        --sidebar-shadow-color: rgba(0,0,0,0.2);
        --header-gradient-start: #38a169;
        --header-gradient-end: #2f855a;
        --header-text: white;
        --header-shadow-color: rgba(0, 0, 0, 0.25);
        --profile-icon-color': 'white;
        --active-link-gradient-start: #48bb78;
        --active-link-gradient-end: #38a169;
        --active-link-shadow-color: rgba(72, 187, 120, 0.5);
        --active-link-border: white;
        --text-color: #2d3748;
        --secondary-text-color: #4a5568;
        --input-border: #a0aec0;
        --input-focus-shadow: rgba(0, 0, 0, 0.2);
        --button-gradient-start: #38a169;
        --button-gradient-end: #2f855a;
        --button-text: white;
        --logout-color: #e53e3e;
        --error-color: #c53030;
        --card-bg: rgba(255, 255, 255, 0.9);
        --card-shadow': 'rgba(0, 0, 0, 0.15);
        --card-border': 'rgba(237, 242, 247, 0.7);
        --toggle-btn-gradient-start: #38a169;
        --toggle-btn-gradient-end: #2f855a;
        --toggle-btn-text: white;
        --toggle-btn-shadow: rgba(0, 0, 0, 0.25);
        --spinner-color: #38a169;
    }

    /* Base Styles */
    body, html {
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: var(--primary-bg);
        color: var(--text-color);
        overflow-x: hidden;
        transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transitions */
    }

    /* Header */
    #mainHeader {
        background: linear-gradient(90deg, var(--header-gradient-start), var(--header-gradient-end));
        color: var(--header-text);
        padding: 1.2rem 1.5rem; /* Adjusted padding */
        font-weight: 800;
        font-size: 2rem; /* Slightly smaller for better fit with profile */
        box-shadow: 0 4px 15px var(--header-shadow-color);
        letter-spacing: -0.05rem;
        transition: all 0.3s ease;
        width: 100%;
        box-sizing: border-box;
        position: sticky; /* Sticky header */
        top: 0;
        left: 0;
        z-index: 1000;
        display: flex;
        justify-content: space-between; /* Space between title and profile */
        align-items: center;
    }

    #headerTitle {
        flex-grow: 1; /* Allows title to take available space */
        text-align: center; /* Center the title */
    }

    .profile-dropdown-container {
        position: relative;
        cursor: pointer;
        font-size: 1.8rem; /* Icon size */
        color: var(--profile-icon-color);
        transition: color 0.3s ease;
    }
    .profile-dropdown-container:hover {
        color: rgba(255, 255, 255, 0.8);
    }

    .profile-dropdown-menu {
        position: absolute;
        top: calc(100% + 10px); /* Position below the icon */
        right: 0;
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 8px 16px var(--card-shadow);
        min-width: 150px;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
        border: 1px solid var(--card-border);
        overflow: hidden; /* Ensure rounded corners for children */
    }

    .profile-dropdown-menu.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .profile-dropdown-menu button {
        display: block;
        width: 100%;
        padding: 0.8rem 1rem;
        text-align: left;
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
        font-weight: 600;
    }
    .profile-dropdown-menu button:hover {
        background-color: var(--sidebar-hover-bg); /* Use sidebar hover for consistency */
        color: var(--sidebar-text); /* White text on hover */
    }
    .profile-dropdown-menu button.logout-btn-dropdown {
        color: var(--logout-color);
    }
    .profile-dropdown-menu button.logout-btn-dropdown:hover {
        background-color: var(--logout-color);
        color: white;
    }


    /* Main Content Area */
    .main-content-area {
        display: flex;
        height: calc(100vh - 78px); /* Adjust height for sticky header */
        width: 100%;
        position: relative;
        transition: height 0.3s ease;
    }
    .main-content-area.fullscreen-active {
        height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        width: 220px;
        background-color: var(--sidebar-bg);
        color: var(--sidebar-text);
        padding: 1.5rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        transition: transform .3s ease, width 0.3s ease, box-shadow 0.3s ease; /* Add width transition */
        box-shadow: 2px 0 15px var(--sidebar-shadow-color);
        position: relative; /* Changed from absolute for easier flow when collapsed */
        height: 100%;
        left: 0;
        top: 0;
        z-index: 999;
        flex-shrink: 0; /* Prevent shrinking */
        border-radius: 0 15px 15px 0;
    }
    .sidebar.collapsed {
        width: var(--sidebar-collapsed-width);
        overflow: hidden;
        align-items: center; /* Center icons */
        padding-left: 0.5rem; /* Adjusted padding */
        padding-right: 0.5rem;
    }
    .sidebar.hidden { /* For mobile off-canvas */
        transform: translateX(-100%);
        position: absolute; /* Revert to absolute for off-canvas */
    }
    .sidebar.active { /* For mobile off-canvas */
        transform: translateX(0%);
    }

    .sidebar h2 {
        color: var(--sidebar-text);
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 1.5rem;
        text-align: center;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .sidebar.collapsed h2 {
        opacity: 0;
        visibility: hidden;
        height: 0;
        margin-bottom: 0;
    }

    .sidebar a {
        color: var(--sidebar-text);
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
        padding: 0.75rem 1rem;
        border-radius: 12px; /* More rounded */
        transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease, border-left 0.3s ease;
        display: flex;
        align-items: center;
        position: relative; /* For tooltip */
        overflow: hidden;
        border: 1px solid transparent; /* For glow effect */
        background: var(--sidebar-bg); /* Default button background */
    }

    .sidebar.collapsed a {
        padding: 0.75rem 0.5rem; /* Adjusted padding for icons */
        justify-content: center; /* Center icon */
    }

    .sidebar a:hover {
        background-color: var(--sidebar-hover-bg);
        transform: translateY(-3px) scale(1.02); /* Lift up effect */
        box-shadow: 0 8px 20px var(--sidebar-shadow-color); /* Stronger shadow on hover */
        border: 1px solid rgba(255, 255, 255, 0.4); /* Subtle border glow */
    }
    .sidebar a:active {
        transform: translateY(0px) scale(0.98); /* Press effect */
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .sidebar a svg, .sidebar a i {
        margin-right: 0.8rem;
        font-size: 1.1rem;
        transition: margin-right 0.3s ease;
        min-width: 20px; /* Ensure icon has space */
    }
    .sidebar.collapsed a svg, .sidebar.collapsed a i {
        margin-right: 0;
    }

    .sidebar a .link-text {
        transition: opacity 0.3s ease, width 0.3s ease, margin-left 0.3s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .sidebar.collapsed a .link-text {
        opacity: 0;
        width: 0;
        margin-left: -0.8rem; /* Hide text completely */
    }

    /* Tooltip for collapsed sidebar */
    .sidebar.collapsed a:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        left: calc(var(--sidebar-collapsed-width) + 10px); /* Position next to collapsed sidebar */
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem 0.8rem;
        border-radius: 6px;
        white-space: nowrap;
        z-index: 1002;
        font-size: 0.9rem;
        pointer-events: none; /* Allows click through tooltip */
        opacity: 0;
        animation: fadeInTooltip 0.3s forwards;
    }

    @keyframes fadeInTooltip {
        to { opacity: 1; }
    }

    .sidebar a.active-link {
        background: linear-gradient(135deg, var(--active-link-gradient-start), var(--active-link-gradient-end));
        box-shadow: 0 6px 15px var(--active-link-shadow-color); /* Enhanced shadow */
        border-left: 5px solid var(--active-link-border);
        padding-left: calc(1rem - 5px); /* Adjust padding for border */
        transform: translateY(-2px) scale(1.01); /* Subtle lift for active */
        border: 1px solid rgba(255, 255, 255, 0.6); /* Active glow */
    }
    .sidebar.collapsed a.active-link {
        padding-left: 0.5rem; /* Adjusted for collapsed state */
        border-left: none; /* No border in collapsed view */
        transform: translateY(0px) scale(1); /* No lift for collapsed active */
    }


    .sidebar a.logout-btn {
        margin-top: auto;
        color: var(--logout-color);
        background: none; /* No gradient for logout default state */
        border: 1px solid var(--logout-color); /* Red border for logout */
    }
    .sidebar a.logout-btn:hover {
        background-color: var(--logout-color);
        color: white;
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4); /* Red shadow on hover */
        border: 1px solid var(--logout-color); /* Keep border same color */
    }
    .sidebar.collapsed a.logout-btn .link-text {
        opacity: 0;
        width: 0;
    }

    .sidebar a.pulse-effect {
        animation: pulse 0.3s ease-out;
    }

    @keyframes pulse {
        0% { transform: scale(1); box-shadow: none; }
        50% { transform: scale(1.02); box-shadow: 0 0 15px rgba(255, 255, 255, 0.4); }
        100% { transform: scale(1); box-shadow: none; }
    }

    /* Main Content */
    .content {
        flex: 1;
        position: relative;
        background-color: var(--primary-bg);
        padding-left: 240px; /* Initial padding for sidebar width + margin */
        transition: padding-left 0.3s ease;
        width: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column; /* Allow footer at bottom */
        justify-content: space-between; /* Push content up, footer down */
        align-items: center;
        overflow-y: auto; /* Enable scrolling for content */
    }
    .content.sidebar-collapsed-active {
        padding-left: calc(var(--sidebar-collapsed-width) + 20px); /* Adjust for collapsed sidebar */
    }

    .main-content-area.fullscreen-active .content {
        padding-left: 0;
    }

    .content-card {
        background-color: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 15px 40px var(--card-shadow); /* More pronounced shadow */
        padding: 2.5rem; /* Increased padding */
        max-width: 800px;
        width: 90%;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 250px;
        opacity: 0;
        animation: fadeIn 0.5s ease-out forwards;
        border: 1px solid var(--card-border); /* Flat-glass border */
        backdrop-filter: blur(5px); /* Glassmorphism effect */
        -webkit-backdrop-filter: blur(5px); /* For Safari */
        margin-top: 2rem; /* Add some top margin to content card */
        margin-bottom: 2rem;
        flex-grow: 1; /* Allow card to grow */
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    #defaultMessage h2 {
        color: var(--text-color);
        font-size: 2rem; /* Larger font size */
        margin-bottom: 0.8rem;
        font-weight: 800;
        letter-spacing: -0.03em;
    }
    #defaultMessage p {
        color: var(--secondary-text-color);
        font-size: 1.2rem; /* Larger font size */
        line-height: 1.7;
    }
    #defaultMessage svg {
        color: var(--button-gradient-start);
        filter: drop-shadow(0 4px 8px rgba(99, 102, 241, 0.4)); /* Shadow for icon */
    }

    /* Iframe and Loading Spinner */
    #toolFrame {
        width: 100%;
        height: 100%;
        border: none;
        display: none; /* Hidden by default */
        background-color: transparent;
        opacity: 0; /* For fade in */
        transition: opacity 0.5s ease-out; /* Fade transition */
    }
    #toolFrame.visible {
        opacity: 1;
    }

    .iframe-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-grow: 1;
    }

    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid var(--spinner-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 0.8s linear infinite;
        position: absolute;
        z-index: 10;
        display: none; /* Hidden by default */
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }


    /* Toggle Sidebar Button (Mobile) */
    #toggleSidebarBtn {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        padding: 0.7rem 1rem;
        font-size: 1rem;
        border-radius: 10px;
        background: linear-gradient(45deg, var(--toggle-btn-gradient-start) 0%, var(--toggle-btn-gradient-end) 100%);
        color: var(--toggle-btn-text);
        border: none;
        cursor: pointer;
        font-weight: 700;
        box-shadow: 0 5px 15px var(--toggle-btn-shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: none; /* Hidden by default, shown by media query on mobile */
    }
    #toggleSidebarBtn:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 20px var(--toggle-btn-shadow), 0 0 10px 3px rgba(255, 255, 255, 0.5);
    }

    /* Toggle Sidebar Collapse Button (Desktop) */
    #toggleSidebarCollapseBtn {
        position: absolute;
        top: 1.5rem;
        right: 1rem;
        background: none;
        border: none;
        color: var(--sidebar-text);
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.3s ease;
        display: none; /* Hidden by default, shown by media query on desktop */
        z-index: 10;
    }
    #toggleSidebarCollapseBtn:hover {
        transform: scale(1.1);
    }
    .sidebar.collapsed #toggleSidebarCollapseBtn {
        right: 0.5rem;
        font-size: 1.2rem;
    }


    /* Login Container */
    #loginContainer {
        padding: 3.5rem 2.5rem;
        text-align: center;
        max-width: 500px;
        margin: 8% auto;
        background-color: var(--login-bg);
        border-radius: 18px;
        box-shadow: 0 15px 40px var(--card-shadow);
        border: 1px solid var(--card-border);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    #loginContainer h2 {
        font-size: 2.2rem;
        font-weight: 900;
        margin-bottom: 2.5rem;
        color: var(--text-color);
        letter-spacing: -0.03em;
    }
    #loginContainer input {
        margin-bottom: 1.5rem;
        padding: 1rem 1.2rem;
        width: calc(100% - 2.4rem);
        border: 1px solid var(--input-border);
        border-radius: 10px;
        font-size: 1.1rem;
        box-sizing: border-box;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    #loginContainer input:focus {
        outline: none;
        border-color: var(--button-gradient-start);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    #loginContainer button {
        padding: 1.1rem 2.8rem;
        background: linear-gradient(135deg, var(--button-gradient-start), var(--button-gradient-end));
        color: var(--button-text);
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.3rem;
        font-weight: 700;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 5px 15px var(--input-focus-shadow);
        margin-top: 1rem;
        position: relative;
        overflow: hidden;
    }
    #loginContainer button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.3);
        transform: skewX(-30deg);
        transition: all 0.5s;
    }
    #loginContainer button:hover::before {
        left: 100%;
    }
    #loginContainer button:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 10px 25px var(--input-focus-shadow);
    }
    #loginContainer button:active {
        transform: translateY(-1px) scale(0.98);
        box-shadow: 0 2px 8px var(--input-focus-shadow);
    }
    #loginError {
        color: var(--error-color);
        margin-top: 1.2rem;
        font-size: 1rem;
        font-weight: 600;
    }

    .plans-redirect-section {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid var(--card-border);
    }
    .plans-redirect-section p {
      margin-bottom: 1.5rem;
      color: var(--secondary-text-color);
      font-size: 1.1rem;
    }
    .plans-redirect-section button {
      padding: 1rem 2.5rem;
      font-size: 1.2rem;
      border-radius: 12px;
    }
    .plans-redirect-section button:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 10px 25px var(--input-focus-shadow);
    }
    .plans-redirect-section button:active {
        transform: translateY(-1px) scale(0.98);
        box-shadow: 0 2px 8px var(--input-focus-shadow);
    }

    #greeting {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--sidebar-bg);
        color: var(--sidebar-text);
        padding: 12px 25px;
        border-radius: 10px;
        z-index: 1000;
        opacity: 0;
        animation: fadeInOut 4s ease-out forwards;
        font-size: 1.2rem;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Animation for greeting */
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translate(-50%, 20px); }
        10% { opacity: 1; transform: translate(-50%, 0); }
        90% { opacity: 1; transform: translate(-50%, 0); }
        100% { opacity: 0; transform: translate(-50%, -20px); }
    }

    /* Theme selector specific styles */
    .sidebar-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .sidebar.collapsed .sidebar-section {
        opacity: 0;
        visibility: hidden;
        height: 0;
        overflow: hidden;
        margin-top: 0;
        padding-top: 0;
    }
    .sidebar-section h3 {
        color: white;
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .sidebar-section select {
        width: 100%;
        padding: 0.7rem 0.9rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background-color: rgba(255, 255, 255, 0.08);
        color: white;
        font-size: 1rem;
        cursor: pointer;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M287%2069.3c-4.1-4.1-10.7-4.1-14.8%200L146.2%20205.8%2020.2%2069.3c-4.1-4.1-10.7-4.1-14.8%200%20c-4.1%204.1-4.1%2010.7%200%2014.8l133%20133c4.1%204.1%2010.7%204.1%2014.8%200l133-133C291.1%2080%20291.1%2073.4%20287%2069.3z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 0.8em top 50%, 0 0;
        background-size: 0.6em auto, 100%;
    }
    .sidebar-section select option {
        background-color: #1e293b;
        color: white;
    }

    /* Footer */
    .footer {
        padding: 1.5rem;
        text-align: center;
        color: var(--secondary-text-color);
        font-size: 0.9rem;
        background-color: var(--primary-bg);
        border-top: 1px solid var(--card-border);
        width: 100%;
        box-sizing: border-box;
    }


    /* Responsive adjustments */
    @media (min-width: 769px) { /* Desktop styles */
        #toggleSidebarCollapseBtn {
            display: block; /* Show collapse button on desktop */
        }
        #toggleSidebarBtn {
            display: none; /* Hide mobile menu button on desktop */
        }
        .sidebar { /* Ensure sidebar starts visible and uncollapsed on desktop */
            transform: translateX(0%);
            position: relative;
        }
        .main-content-area .content {
            padding-left: 240px; /* Default padding for expanded sidebar */
        }
    }

    @media (max-width: 768px) { /* Mobile styles */
        #toggleSidebarBtn {
            display: block; /* Show mobile menu button on mobile */
        }
        #toggleSidebarCollapseBtn {
            display: none; /* Hide collapse button on mobile */
        }
        #mainHeader {
            font-size: 1.8rem;
            padding: 0.8rem 1rem;
        }
        .main-content-area {
            height: calc(100vh - 60px);
        }
        .content {
            padding-left: 0; /* No padding on mobile content */
        }
        .sidebar {
            transform: translateX(-100%); /* Start hidden on mobile */
            border-radius: 0;
            position: fixed; /* Fixed position for off-canvas */
            height: 100%;
            top: 0;
            left: 0;
            box-shadow: 4px 0 20px var(--sidebar-shadow-color);
            width: 280px; /* Wider sidebar on mobile */
        }
        .sidebar.active { /* Show sidebar on mobile */
            transform: translateX(0%);
        }
        .sidebar.collapsed { /* No collapsed mode on mobile, so ensure it slides out fully */
            width: 280px; /* Maintain full width for off-canvas */
            transform: translateX(-100%);
        }
        .content-card {
            padding: 2rem 1.5rem;
            max-width: 95%;
        }
        #defaultMessage h2 {
            font-size: 1.8rem;
        }
        #defaultMessage p {
            font-size: 1.1rem;
        }
        #loginContainer {
            margin: 5% auto;
            padding: 2.5rem 2rem;
            width: 90%;
            max-width: 400px;
        }
        #loginContainer h2 {
            font-size: 2rem;
            margin-bottom: 2rem;
        }
        #loginContainer input {
            padding: 0.8rem 1rem;
            font-size: 1rem;
        }
        #loginContainer button,
        .plans-redirect-section button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
        .profile-dropdown-container {
            font-size: 1.6rem;
        }
    }

    @media (max-width: 480px) {
        #loginContainer {
            margin: 2% auto;
            padding: 2rem 1.5rem;
        }
        #loginContainer h2 {
            font-size: 1.7rem;
        }
        #loginContainer input {
            font-size: 0.95rem;
        }
        #loginContainer button,
        .plans-redirect-section button {
            padding: 0.9rem 1.8rem;
            font-size: 1rem;
        }
        #mainHeader {
            font-size: 1.5rem;
        }
        #greeting {
            font-size: 1rem;
            padding: 8px 15px;
        }
        .content-card {
            padding: 1.5rem 1rem;
        }
        #defaultMessage h2 {
            font-size: 1.4rem;
        }
        #defaultMessage p {
            font-size: 0.95rem;
        }
        .profile-dropdown-container {
            font-size: 1.4rem;
        }
    }
  </style>
</head>
<body>
  <div id="mainHeader">
    <div id="headerTitle">Check My Steno Dashboard</div>
    <div class="profile-dropdown-container" id="profileDropdownContainer">
        <i class="fas fa-user-circle"></i>
        <div class="profile-dropdown-menu" id="profileDropdownMenu">
            <button onclick="logout()" class="logout-btn-dropdown">Logout</button>
        </div>
    </div>
  </div>

  <div id="loginContainer">
    <h2>Access Check My Steno</h2>
    <input type="text" id="userName" placeholder="Enter Your Name" /><br />
    <input type="email" id="userEmail" placeholder="Enter Your Email" /><br />
    <input type="text" id="accessCode" placeholder="Enter Access Code" /><br />
    <button onclick="validateAccessCode()">Enter</button>
    <p id="loginError" style="color: red;"></p>

    <div class="plans-redirect-section">
        <p>Don't have an access code?</p>
        <button onclick="redirectToPlans()">Subscribe Now</button>
    </div>
  </div>

  <div class="main-content-area" id="mainContentArea" style="display: none;">
    <!-- Toggle button for mobile sidebar -->
    <button id="toggleSidebarBtn">☰ Menu</button>

    <div class="sidebar" id="sidebar">
      <button id="toggleSidebarCollapseBtn">
        <i class="fas fa-angle-double-left"></i>
      </button>
      <h2 id="greeting">Welcome!</h2>
      <a onclick="loadTool('home.html', this)" class="active-link" data-tooltip="Home"><i class="fas fa-home"></i> <span class="link-text">Home</span></a>
      <a onclick="loadTool('practice-kc.html', this)" data-tooltip="Practice KC"><i class="fas fa-keyboard"></i> <span class="link-text">Practice KC</span></a>
      <a onclick="loadTool('test-analysis.html', this)" data-tooltip="Test Analysis"><i class="fas fa-chart-line"></i> <span class="link-text">Test Analysis</span></a>
      <a onclick="loadTool('transcription-checker.html', this)" data-tooltip="Transcription Checker"><i class="fas fa-check-double"></i> <span class="link-text">Transcription Checker</span></a>
      <a onclick="loadTool('About.html', this)" data-tooltip="About"><i class="fas fa-info-circle"></i> <span class="link-text">About</span></a>

      <div class="sidebar-section">
        <h3><i class="fas fa-palette"></i> <span class="link-text">Themes</span></h3>
        <select id="themeSelector" onchange="applyTheme(this.value)">
          </select>
      </div>

      <a onclick="logout()" class="logout-btn" data-tooltip="Logout"><i class="fas fa-sign-out-alt"></i> <span class="link-text">Logout</span></a>
    </div>

    <div class="content" id="mainContent">
        <div class="iframe-container">
            <div id="defaultMessage" class="content-card">
                <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1rem;">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                    <path d="M2 17l10 5 10-5"></path>
                    <path d="M2 12l10 5 10-5"></path>
                </svg>
                <h2>Welcome to Check My Steno Dashboard!</h2>
                <p>Select an option from the sidebar to begin, or explore the pre-loaded Home page.</p>
            </div>
            <iframe id="toolFrame" src="" frameborder="0" onload="hideSpinner()"></iframe>
            <div class="loading-spinner" id="loadingSpinner"></div>
        </div>
        <footer class="footer">
            © 2025 Check My Steno. All rights reserved.
        </footer>
    </div>
  </div>

  <script>
    // Firebase configuration - DO NOT CHANGE (as per original code)
    const FBCONFIG = {apiKey:"AIzaSyDPkUWIrsibI-hzKJ8ljhvawdJ9Nq4-cpE",authDomain:"checkmysteno.firebaseapp.com",projectId:"checkmysteno",storageBucket:"checkmysteno.firebasestorage.app",messagingSenderId:"719325115943",appId:"1:719325115943:web:0dd50a67978816d42a8002"};
    firebase.initializeApp(FBCONFIG);
    const DB = firebase.firestore();
    const GID = id => document.getElementById(id); // Helper function

    let accessCodeUnsubscribe = null; // Firestore listener unsubscribe function

    // Theme definitions with emojis
    const themes = {
        'Default': { /* Default theme variables */
            '--primary-bg': '#f3f4f6',
            '--login-bg': 'white',
            '--sidebar-bg': '#1e293b',
            '--sidebar-text': 'white',
            '--sidebar-hover-bg': 'rgba(255, 255, 255, 0.15)',
            '--sidebar-shadow-color': 'rgba(0,0,0,0.2)',
            '--header-gradient-start': '#7c3aed',
            '--header-gradient-end': '#4f46e5',
            '--header-text': 'white',
            '--header-shadow-color': 'rgba(0, 0, 0, 0.3)',
            '--profile-icon-color': 'white',
            '--active-link-gradient-start': '#6366f1',
            '--active-link-gradient-end': '#ec4899',
            '--active-link-shadow-color': 'rgba(99, 102, 241, 0.6)',
            '--active-link-border': 'white',
            '--text-color': '#333',
            '--secondary-text-color': '#6b7280',
            '--input-border': '#cbd5e1',
            '--input-focus-shadow': 'rgba(0, 0, 0, 0.25)',
            '--button-gradient-start': '#6366f1',
            '--button-gradient-end': '#ec4899',
            '--button-text': 'white',
            '--logout-color': '#ef4444',
            '--error-color': '#ef4444',
            '--card-bg': 'rgba(255, 255, 255, 0.9)',
            '--card-shadow': 'rgba(0, 0, 0, 0.15)',
            '--card-border': 'rgba(226, 232, 240, 0.7)',
            '--toggle-btn-gradient-start': '#6a82fb',
            '--toggle-btn-gradient-end': '#fc5c7d',
            '--toggle-btn-text': 'white',
            '--toggle-btn-shadow': 'rgba(0, 0, 0, 0.25)',
            '--spinner-color': '#6366f1',
        },
        'Dark 🌙': { /* Dark theme variables */
            '--primary-bg': '#1a202c',
            '--login-bg': '#2d3748',
            '--sidebar-bg': '#2d3748',
            '--sidebar-text': '#f7fafc',
            '--sidebar-hover-bg': 'rgba(255, 255, 255, 0.08)',
            '--sidebar-shadow-color': 'rgba(0,0,0,0.6)',
            '--header-gradient-start': '#4a5568',
            '--header-gradient-end': '#2d3748',
            '--header-text': '#f7fafc',
            '--header-shadow-color': 'rgba(0, 0, 0, 0.6)',
            '--profile-icon-color': '#f7fafc',
            '--active-link-gradient-start': '#ecc94b',
            '--active-link-gradient-end': '#ed8936',
            '--active-link-shadow-color': 'rgba(236, 178, 101, 0.4)',
            '--active-link-border': '#ecc94b',
            '--text-color': '#f7fafc',
            '--secondary-text-color': '#cbd5e1',
            '--input-border': '#4a5568',
            '--input-focus-shadow': 'rgba(0, 0, 0, 0.5)',
            '--button-gradient-start': '#ecc94b',
            '--button-gradient-end': '#ed8936',
            '--button-text': '#2d3748',
            '--logout-color': '#feb2b2',
            '--error-color': '#fc8181',
            '--card-bg': 'rgba(45, 55, 72, 0.9)',
            '--card-shadow': 'rgba(0, 0, 0, 0.5)',
            '--card-border': 'rgba(74, 85, 104, 0.7)',
            '--toggle-btn-gradient-start': '#ecc94b',
            '--toggle-btn-gradient-end': '#ed8936',
            '--toggle-btn-text': '#2d3748',
            '--toggle-btn-shadow': 'rgba(0, 0, 0, 0.5)',
            '--spinner-color': '#ecc94b',
        },
        'Ocean Blue 🌊': { /* Ocean Blue theme variables */
            '--primary-bg': '#e0f2f7',
            '--login-bg': '#ffffff',
            '--sidebar-bg': '#0a1d37',
            '--sidebar-text': '#e0f2f7',
            '--sidebar-hover-bg': 'rgba(173, 216, 230, 0.15)',
            '--sidebar-shadow-color': 'rgba(0,0,0,0.25)',
            '--header-gradient-start': '#4299e1',
            '--header-gradient-end': '#3182ce',
            '--header-text': 'white',
            '--header-shadow-color': 'rgba(0, 0, 0, 0.25)',
            '--profile-icon-color': 'white',
            '--active-link-gradient-start': '#667eea',
            '--active-link-gradient-end': '#764ba2',
            '--active-link-shadow-color': 'rgba(102, 126, 234, 0.5)',
            '--active-link-border': 'white',
            '--text-color': '#2a4365',
            '--secondary-text-color': '#4a5568',
            '--input-border': '#a0aec0',
            '--input-focus-shadow': 'rgba(0, 0, 0, 0.2)',
            '--button-gradient-start': '#4299e1',
            '--button-gradient-end': '#3182ce',
            '--button-text': 'white',
            '--logout-color': '#f56565',
            '--error-color': '#e53e3e',
            '--card-bg': 'rgba(255, 255, 255, 0.9)',
            '--card-shadow': 'rgba(0, 0, 0, 0.15)',
            '--card-border': 'rgba(237, 242, 247, 0.7)',
            '--toggle-btn-gradient-start': '#4299e1',
            '--toggle-btn-gradient-end': '#3182ce',
            '--toggle-btn-text': 'white',
            '--toggle-btn-shadow': 'rgba(0, 0, 0, 0.25)',
            '--spinner-color': '#4299e1',
        },
        'Forest Green 🌲': { /* Forest Green theme variables */
            '--primary-bg': '#f0fdf4',
            '--login-bg': '#ffffff',
            '--sidebar-bg': '#143105',
            '--sidebar-text': '#ecfdf5',
            '--sidebar-hover-bg': 'rgba(144, 238, 144, 0.15)',
            '--sidebar-shadow-color': 'rgba(0,0,0,0.2)',
            '--header-gradient-start': '#38a169',
            '--header-gradient-end': '#2f855a',
            '--header-text': 'white',
            '--header-shadow-color': 'rgba(0, 0, 0, 0.25)',
            '--profile-icon-color': 'white',
            '--active-link-gradient-start': '#48bb78',
            '--active-link-gradient-end': '#38a169',
            '--active-link-shadow-color': 'rgba(72, 187, 120, 0.5)',
            '--active-link-border': 'white',
            '--text-color': '#2d3748',
            '--secondary-text-color': '#4a5568',
            '--input-border': '#a0aec0',
            '--input-focus-shadow': 'rgba(0, 0, 0, 0.2)',
            '--button-gradient-start': '#38a169',
            '--button-gradient-end': '#2f855a',
            '--button-text': 'white',
            '--logout-color': '#e53e3e',
            '--error-color': '#c53030',
            '--card-bg': 'rgba(255, 255, 255, 0.9)',
            '--card-shadow': 'rgba(0, 0, 0, 0.15)',
            '--card-border': 'rgba(237, 242, 247, 0.7)',
            '--toggle-btn-gradient-start': '#38a169',
            '--toggle-btn-gradient-end': '#2f855a',
            '--toggle-btn-text': 'white',
            '--toggle-btn-shadow': 'rgba(0, 0, 0, 0.25)',
            '--spinner-color': '#38a169',
        }
    };

    /**
     * Applies the selected theme by updating CSS custom properties on the document root.
     * @param {string} themeName - The name of the theme to apply.
     */
    function applyTheme(themeName) {
        // Remove emoji for lookup in themes object, keep for display
        const themeKey = themeName.split(' ')[0]; 
        const selectedTheme = themes[themeName] || themes[themeKey]; // Try with or without emoji
        if (selectedTheme) {
            for (const [property, value] of Object.entries(selectedTheme)) {
                document.documentElement.style.setProperty(property, value);
            }
            // Set data-theme attribute on HTML for CSS selectors
            document.documentElement.setAttribute('data-theme', themeKey); 
            localStorage.setItem('selectedTheme', themeName); // Save full name with emoji
        } else {
            console.warn('Theme not found:', themeName);
        }
    }

    /**
     * Initializes the theme selector dropdown and applies the saved theme from localStorage.
     */
    function initializeThemes() {
        const themeSelector = GID('themeSelector');
        if (themeSelector) {
            themeSelector.innerHTML = ''; // Clear existing options
            for (const themeName in themes) {
                const option = document.createElement('option');
                option.value = themeName;
                option.textContent = themeName;
                themeSelector.appendChild(option);
            }

            // Load saved theme or default to 'Default'
            const savedTheme = localStorage.getItem('selectedTheme') || 'Default';
            if (themes[savedTheme]) {
                applyTheme(savedTheme);
                themeSelector.value = savedTheme;
            } else { // Fallback if saved theme key doesn't exactly match (e.g. 'Dark' vs 'Dark 🌙')
                const savedThemeKey = savedTheme.split(' ')[0];
                const foundTheme = Object.keys(themes).find(key => key.startsWith(savedThemeKey));
                if (foundTheme) {
                    applyTheme(foundTheme);
                    themeSelector.value = foundTheme;
                } else {
                    applyTheme('Default');
                    themeSelector.value = 'Default';
                }
            }
        }
    }

    /**
     * Handles user logout, clearing session data and returning to the login screen.
     * @param {string} [message="Your session has ended. Please re-enter your access code."] - Message to display on logout.
     */
    function UL(m=atob("WW91ciBzZXNzaW9uIGhhcyBlbmRlZC4gUGxlYXNlIHJlLWVudGVyIHlvdXIgYWNjZXNzIGNvZGUu")) {
        if (accessCodeUnsubscribe) {
            accessCodeUnsubscribe();
            accessCodeUnsubscribe = null;
            console.log("Unsubscribed from access code listener.");
        }
        localStorage.removeItem(atob("Y2hlY2tNeVN0ZW5vVXNlcg==")); // "checkMyStenoUser"
        localStorage.removeItem(atob("Y3VycmVudEFjY2Vzc0NvZGU=")); // "currentAccessCode"
        
        GID("loginContainer").style.display = "block";
        GID("mainContentArea").style.display = "none"; 
        GID("mainHeader").style.display = "block"; // Ensure header is visible on login screen
        // GID("toggleSidebarBtn").style.display = "none"; // CSS handles this now
        GID("loginError").textContent = m;
        GID("accessCode").value = ""; // Clear access code input
        
        // Hide iframe and show default message
        GID("toolFrame").src = "";
        GID("toolFrame").style.display = "none";
        GID("toolFrame").classList.remove('visible'); // Remove visible class
        GID("defaultMessage").style.display = "flex"; // Show default message card

        // Deactivate all sidebar links
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.classList.remove('active-link');
        });

        // Hide profile dropdown if open
        GID("profileDropdownMenu").classList.remove('show');

        // Ensure sidebar is hidden on logout for mobile
        const sidebar = GID('sidebar');
        if (window.innerWidth <= 768) {
            sidebar.classList.add('hidden');
            sidebar.classList.remove('active');
        } else {
            // On desktop, ensure sidebar is not collapsed
            sidebar.classList.remove('collapsed');
            GID('mainContent').classList.remove('sidebar-collapsed-active');
            GID('toggleSidebarCollapseBtn').innerHTML = '<i class="fas fa-angle-double-left"></i>';
        }
    }

    /**
     * Starts a real-time listener for the user's access code status in Firestore.
     * If the code becomes invalid, the user is logged out.
     */
    function startAccessCodeListener() {
        const currentAccessCode = localStorage.getItem(atob("Y3VycmVudEFjY2Vzc0NvZGU="));
        if (!currentAccessCode) {
            console.warn("No current access code found in localStorage to start listener.");
            return;
        }

        // Unsubscribe from any existing listener before creating a new one
        if (accessCodeUnsubscribe) {
            accessCodeUnsubscribe();
            console.log("Existing access code listener unsubscribed before new one.");
        }

        const accessCodeRef = DB.collection(atob("YWNjZXNzQ29kZXM=")).doc(currentAccessCode);

        // Set up the real-time listener
        accessCodeUnsubscribe = accessCodeRef.onSnapshot(doc => {
            if (doc.exists && doc.data().valid === true) {
                console.log(atob("QWNjZXNzIGNvZGUgaXMgc3RpbGwgdmFsaWQgdmJhIHJlYWwtdGltZSBsaXN0ZW5lci4=")); // Access code is still valid via real-time listener.
                GID("loginError").textContent = ""; // Clear any previous error messages
            } else {
                console.log("Access code no longer valid or document does not exist. Logging out.");
                UL(atob("WW91ciBzZXNzaW9uIGhhcyBiZWVuIHRlcm1pbmF0ZWQgYnkgdGhlIGFkbWluaXN0cmF0b3Igb3IgdGhlIGFjY2VzcyBjb2RlIGlzIG5vIGxvbmdlciB2YWxpZC4=")); // Your session has been terminated by the administrator or the access code is no longer valid.
            }
        }, error => {
            console.error(atob("RXJyb3IgbGlzdGVuaW5nIHRvIGFjY2VzcyBjb2RlIHN0YXR1czo="), error); // Error listening to access code status:
            UL(atob("QSBjb25uZWN0aW9uIGVycm9yIG9jY3VycmVkIHdoaWxlIHZlcnlmeW91ciBzZXNzaW9uLg==")); // A connection error occurred while verifying your session.
        });
    }

    /**
     * Validates the entered access code, name, and email against Firestore.
     * On successful validation, logs the user in and redirects to the dashboard.
     */
    async function validateAccessCode() {
        const code = GID("accessCode").value.trim();
        const name = GID("userName").value.trim();
        const email = GID("userEmail").value.trim();
        const loginError = GID("loginError");

        if (!name || !email || !code) {
            loginError.textContent = "Name, email, and access code are required.";
            return;
        }

        try {
            const accessCodeRef = DB.collection(atob("YWNjZXNzQ29kZXM=")).doc(code);
            const doc = await accessCodeRef.get();

            if (doc.exists) {
                const userData = doc.data();
                if (userData.valid) {
                    const userLoginsRef = DB.collection("userLogins");
                    const querySnapshot = await userLoginsRef
                        .where("name", "==", name)
                        .where("email", "==", email)
                        .get();

                    const userSessionData = {
                        name: name,
                        email: email,
                        usedAccessCode: code,
                        loginTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (!querySnapshot.empty) {
                        // User exists, update their login record
                        await querySnapshot.docs[0].ref.update(userSessionData);
                    } else {
                        // New user, create a new login record
                        await userLoginsRef.add(userSessionData);
                    }

                    // Store user data and access code in local storage
                    localStorage.setItem(atob("Y2hlY2tNeVN0ZW5vVXNlcg=="), JSON.stringify(userData)); // Corrected string
                    localStorage.setItem(atob("Y3VycmVudEFjY2Vzc0NvZGU="), code);
                    
                    // Transition UI to dashboard
                    GID("loginContainer").style.display = "none";
                    GID("mainContentArea").style.display = "flex"; 
                    GID("mainHeader").style.display = "flex"; // Ensure header is displayed for authenticated view

                    // Update greeting and animate
                    const greetingEl = GID("greeting");
                    greetingEl.textContent = `${atob("V2VsY29tZSwg")}${userData.name || name}!`; // Welcome,
                    greetingEl.style.animation = 'none'; // Reset animation
                    greetingEl.offsetHeight; // Trigger reflow
                    greetingEl.style.animation = 'fadeInOut 4s ease-out forwards'; // Apply animation
                    
                    // Start real-time listener for access code validity
                    startAccessCodeListener();
                    
                    // Load the home tool and set active link
                    loadTool('home.html', document.querySelector('.sidebar a[onclick*="home.html"]'));
                    
                    // Ensure sidebar state is correct based on screen size (CSS will handle display)
                    if (window.innerWidth <= 768) {
                        GID("sidebar").classList.add('hidden'); // Ensure sidebar starts hidden on mobile
                    } else {
                        GID("sidebar").classList.remove('hidden'); // Ensure sidebar is visible on desktop
                        GID("sidebar").classList.remove('collapsed'); // Ensure it's expanded by default
                        GID('mainContent').classList.remove('sidebar-collapsed-active');
                        GID('toggleSidebarCollapseBtn').innerHTML = '<i class="fas fa-angle-double-left"></i>';
                    }
                    loginError.textContent = ""; // Clear error message on success

                } else {
                    UL(atob("QWNjZXNzIENvZGUgaXMgbm8gbG9uZ2VyIHZhbGlkLiBQbGVhc2UgY29udGFjdCBzdXBwb3J0Lg==")); // Access Code is no longer valid. Please contact support.
                }
            } else {
                loginError.textContent = atob("SW52YWxpZCBBY2Nlc3MgQ29kZS4="); // Invalid Access Code.
            }
        } catch (error) {
            console.error("Login error:", error);
            loginError.textContent = `${atob("RXJyb3I6IA==")}${error.message}`; // Error:
        }
    }

    /**
     * Calls the UL function to log the user out.
     */
    function logout() { UL(atob("WW91IGhhdmUgYmVlbiBsb2dnZWQgb3V0IG1hbnVhbGx5Lg==")); } // You have been logged out manually.

    /**
     * Loads a specified HTML tool into the iframe and updates sidebar state.
     * @param {string} P - The path to the HTML tool (e.g., 'home.html').
     * @param {HTMLElement} clickedLink - The sidebar link element that was clicked.
     */
    function loadTool(P, clickedLink) {
        const toolFrame = GID("toolFrame");
        const sidebar = GID("sidebar");
        // const toggleSidebarBtn = GID("toggleSidebarBtn"); // No longer needed for display control
        const mainHeader = GID("mainHeader");
        const mainContentArea = GID("mainContentArea");
        const defaultMessage = GID("defaultMessage"); 
        const loadingSpinner = GID("loadingSpinner");
        const toggleSidebarCollapseBtn = GID("toggleSidebarCollapseBtn");


        // Hide default message
        if (defaultMessage) defaultMessage.style.display = "none";

        // Show spinner and prepare iframe for loading
        showSpinner();
        toolFrame.classList.remove('visible'); // Ensure it's hidden before new content loads
        toolFrame.style.display = "block"; // Show iframe element, but opacity 0

        // Set iframe source - this will trigger onload when content is ready
        toolFrame.src = P;

        // Adjust layout for iframe display
        if (mainHeader) mainHeader.style.display = 'none'; // Hide main header when tool is fullscreen
        if (sidebar) {
            if (window.innerWidth <= 768) {
                // On mobile, hide the sidebar
                sidebar.classList.add('hidden');
                sidebar.classList.remove('active'); // Ensure active class is removed
            } else {
                // On desktop, collapse the sidebar if it's not already
                if (!sidebar.classList.contains('collapsed')) {
                    sidebar.classList.add('collapsed');
                    GID('mainContent').classList.add('sidebar-collapsed-active');
                    if (toggleSidebarCollapseBtn) toggleSidebarCollapseBtn.innerHTML = '<i class="fas fa-angle-double-right"></i>'; // Change icon
                }
            }
        }
        if (mainContentArea) mainContentArea.classList.add('fullscreen-active'); // Expand content area

        // The display of toggleSidebarBtn is now solely controlled by CSS media queries.
        // No need to explicitly set its display here.

        // Update active link styling
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.classList.remove('active-link');
        });
        if (clickedLink) {
            clickedLink.classList.add('active-link');
            clickedLink.classList.add('pulse-effect');
            setTimeout(() => {
                clickedLink.classList.remove('pulse-effect');
            }, 300);
        }
    }

    /**
     * Shows the loading spinner.
     */
    function showSpinner() {
        GID("loadingSpinner").style.display = "block";
    }

    /**
     * Hides the loading spinner and fades in the iframe content.
     */
    function hideSpinner() {
        GID("loadingSpinner").style.display = "none";
        GID("toolFrame").classList.add('visible'); // Fade in iframe
    }


    // Event listener for mobile sidebar toggle button
    GID("toggleSidebarBtn").onclick = function() {
        const sidebar = GID("sidebar");
        const button = GID("toggleSidebarBtn");
        const mainHeader = GID("mainHeader");
        const mainContentArea = GID("mainContentArea");
        const toolFrame = GID("toolFrame"); 
        const defaultMessage = GID("defaultMessage"); 

        if (sidebar.classList.contains('active') || !sidebar.classList.contains('hidden')) { 
            // Sidebar is currently active (on mobile) or not explicitly hidden.
            // Hide sidebar
            sidebar.classList.add('hidden');
            sidebar.classList.remove('active'); 
            if (mainHeader) mainHeader.style.display = 'none';
            if (mainContentArea) mainContentArea.classList.add('fullscreen-active');
            button.textContent = "☰ Menu";
            
            // Restore toolframe visibility if a tool was loaded
            if (toolFrame.src && toolFrame.src !== window.location.href + '#') { 
                toolFrame.style.display = "block";
                toolFrame.classList.add('visible');
                if (defaultMessage) defaultMessage.style.display = "none";
            } else {
                // If no tool loaded, show default message
                toolFrame.style.display = "none";
                toolFrame.classList.remove('visible');
                if (defaultMessage) defaultMessage.style.display = "flex";
            }

        } else { 
            // Sidebar is currently hidden
            // Show sidebar
            sidebar.classList.remove('hidden');
            sidebar.classList.add('active'); 
            if (mainHeader) mainHeader.style.display = 'block';
            if (mainContentArea) mainContentArea.classList.remove('fullscreen-active');
            button.textContent = "✖ Close";

            // Hide iframe and show default message when sidebar is open on mobile
            if (toolFrame) toolFrame.src = "";
            if (toolFrame) toolFrame.style.display = "none";
            if (toolFrame) toolFrame.classList.remove('visible');
            if (defaultMessage) defaultMessage.style.display = "flex";
            
            // Deactivate sidebar links
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active-link');
            });
        }
    };

    // Event listener for desktop sidebar collapse button
    GID("toggleSidebarCollapseBtn").onclick = function() {
        const sidebar = GID("sidebar");
        const mainContent = GID("mainContent");
        const collapseBtn = GID("toggleSidebarCollapseBtn");

        if (sidebar.classList.contains('collapsed')) {
            // Expand sidebar
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('sidebar-collapsed-active');
            collapseBtn.innerHTML = '<i class="fas fa-angle-double-left"></i>';
        } else {
            // Collapse sidebar
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed-active');
            collapseBtn.innerHTML = '<i class="fas fa-angle-double-right"></i>'; // Change icon to point right
        }
    };

    // Event listener for profile dropdown toggle
    GID('profileDropdownContainer').onclick = function(event) {
        const dropdownMenu = GID('profileDropdownMenu');
        dropdownMenu.classList.toggle('show');
        event.stopPropagation(); // Prevent click from closing immediately
    };

    // Close the dropdown if the user clicks outside of it
    window.onclick = function(event) {
        if (!event.target.matches('.profile-dropdown-container') && !event.target.matches('.profile-dropdown-container i')) {
            const dropdownMenu = GID('profileDropdownMenu');
            if (dropdownMenu.classList.contains('show')) {
                dropdownMenu.classList.remove('show');
            }
        }
    };

    /**
     * Redirects the user to the plans.html page.
     */
    function redirectToPlans() {
        window.location.href = 'plans.html';
    }

    /**
     * Initializes the application on page load.
     * Checks for existing user session and displays appropriate UI.
     */
    window.onload = function() {
        initializeThemes(); // Initialize themes on page load
        const storedUser = localStorage.getItem(atob("Y2hlY2tNeVN0ZW5vVXNlcg==")); // "checkMyStenoUser"
        const storedAccessCode = localStorage.getItem(atob("Y3VycmVudEFjY2Vzc0NvZGU=")); // "currentAccessCode"
        const sidebar = GID("sidebar");
        const mainContent = GID("mainContent");
        const toggleSidebarCollapseBtn = GID("toggleSidebarCollapseBtn");


        if (storedUser && storedAccessCode) {
            // If user data and access code exist, show dashboard
            GID("loginContainer").style.display = "none";
            GID("mainContentArea").style.display = "flex"; 
            GID("mainHeader").style.display = "flex"; // Ensure header is visible

            const userData = JSON.parse(storedUser);
            const greetingEl = GID("greeting");
            greetingEl.textContent = `${atob("V2VsY29tZSwg")}${(userData.name || 'User')}!`; // Welcome,
            greetingEl.style.animation = 'none'; // Reset animation
            greetingEl.offsetHeight; // Trigger reflow
            greetingEl.style.animation = 'fadeInOut 4s ease-out forwards'; // Apply animation
            
            startAccessCodeListener(); // Start listening for access code validity
            
            // Load the home tool by default and activate its link
            loadTool('home.html', document.querySelector('.sidebar a[onclick*="home.html"]')); 

            // Handle sidebar visibility based on screen size
            if (window.innerWidth <= 768) {
                sidebar.classList.add('hidden'); // Ensure sidebar starts hidden on mobile
                mainContent.classList.add('fullscreen-active'); // On mobile, content area is full screen initially
                // toggleSidebarBtn's display is handled by CSS
            } else {
                sidebar.classList.remove('hidden'); // Ensure sidebar is visible on desktop
                sidebar.classList.remove('collapsed'); // Ensure it's expanded by default
                mainContent.classList.remove('sidebar-collapsed-active'); // Ensure content adjusts for sidebar
                if (toggleSidebarCollapseBtn) toggleSidebarCollapseBtn.innerHTML = '<i class="fas fa-angle-double-left"></i>'; // Default icon
                // toggleSidebarCollapseBtn's display is handled by CSS
            }

        } else {
            // If no session, show login container
            GID("loginContainer").style.display = "block";
            GID("mainContentArea").style.display = "none";
            sidebar.classList.add('hidden'); // Ensure sidebar is hidden
            GID("mainHeader").style.display = "block"; // Ensure header is visible on login
            // GID("toggleSidebarBtn").style.display = "none"; // CSS handles this now
            GID("toolFrame").style.display = "none"; // Hide iframe
            GID("defaultMessage").style.display = "flex"; // Show default message
        }
    };
  </script>
</body>
</html>
